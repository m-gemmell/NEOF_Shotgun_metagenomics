<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Taxonomic profiling | Shotgun Metagenomics</title>
  <meta name="description" content="Chapter 6 Taxonomic profiling | Shotgun Metagenomics" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Taxonomic profiling | Shotgun Metagenomics" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Taxonomic profiling | Shotgun Metagenomics" />
  
  
  

<meta name="author" content="Sam Haldenby and Matthew Gemmell" />


<meta name="date" content="2021-04-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="05-Trimming_data.html"/>
<link rel="next" href="07-Functional_profiling.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a>Shotgun Metagenomics</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="01-Shotgun_metagenomics.html"><a href="01-Shotgun_metagenomics.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="02-Overview.html"><a href="02-Overview.html"><i class="fa fa-check"></i><b>2</b> Overview</a>
<ul>
<li class="chapter" data-level="2.1" data-path="02-Overview.html"><a href="02-Overview.html#what-is-metagenomics"><i class="fa fa-check"></i><b>2.1</b> What is metagenomics?</a></li>
<li class="chapter" data-level="2.2" data-path="02-Overview.html"><a href="02-Overview.html#why-metagenomics"><i class="fa fa-check"></i><b>2.2</b> Why metagenomics?</a></li>
<li class="chapter" data-level="2.3" data-path="02-Overview.html"><a href="02-Overview.html#metagenomics-vs-metagenetics"><i class="fa fa-check"></i><b>2.3</b> Metagenomics vs Metagenetics</a></li>
<li class="chapter" data-level="2.4" data-path="02-Overview.html"><a href="02-Overview.html#tutorial-overview"><i class="fa fa-check"></i><b>2.4</b> Tutorial overview</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="02-Overview.html"><a href="02-Overview.html#basics"><i class="fa fa-check"></i><b>2.4.1</b> Basics</a></li>
<li class="chapter" data-level="2.4.2" data-path="02-Overview.html"><a href="02-Overview.html#structure"><i class="fa fa-check"></i><b>2.4.2</b> Structure</a></li>
<li class="chapter" data-level="2.4.3" data-path="02-Overview.html"><a href="02-Overview.html#content"><i class="fa fa-check"></i><b>2.4.3</b> Content</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="03-Start.html"><a href="03-Start.html"><i class="fa fa-check"></i><b>3</b> Before we start</a></li>
<li class="chapter" data-level="4" data-path="04-Raw_data.html"><a href="04-Raw_data.html"><i class="fa fa-check"></i><b>4</b> Raw data</a>
<ul>
<li class="chapter" data-level="4.1" data-path="04-Raw_data.html"><a href="04-Raw_data.html#obtaining-the-data"><i class="fa fa-check"></i><b>4.1</b> Obtaining the data</a></li>
<li class="chapter" data-level="4.2" data-path="04-Raw_data.html"><a href="04-Raw_data.html#checking-quality-control"><i class="fa fa-check"></i><b>4.2</b> Checking quality control</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="05-Trimming_data.html"><a href="05-Trimming_data.html"><i class="fa fa-check"></i><b>5</b> Quality control</a>
<ul>
<li class="chapter" data-level="5.1" data-path="05-Trimming_data.html"><a href="05-Trimming_data.html#removing-adapters-and-low-quality-bases"><i class="fa fa-check"></i><b>5.1</b> Removing adapters and low quality bases</a></li>
<li class="chapter" data-level="5.2" data-path="05-Trimming_data.html"><a href="05-Trimming_data.html#rename-the-files"><i class="fa fa-check"></i><b>5.2</b> Rename the files</a></li>
<li class="chapter" data-level="5.3" data-path="05-Trimming_data.html"><a href="05-Trimming_data.html#inspect-the-trimmed-data"><i class="fa fa-check"></i><b>5.3</b> Inspect the trimmed data</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="06-Taxonomic_profiling.html"><a href="06-Taxonomic_profiling.html"><i class="fa fa-check"></i><b>6</b> Taxonomic profiling</a>
<ul>
<li class="chapter" data-level="6.1" data-path="06-Taxonomic_profiling.html"><a href="06-Taxonomic_profiling.html#running-kraken"><i class="fa fa-check"></i><b>6.1</b> Running Kraken</a></li>
<li class="chapter" data-level="6.2" data-path="06-Taxonomic_profiling.html"><a href="06-Taxonomic_profiling.html#visualising-kraken-output"><i class="fa fa-check"></i><b>6.2</b> Visualising Kraken output</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="06-Taxonomic_profiling.html"><a href="06-Taxonomic_profiling.html#krona-plot"><i class="fa fa-check"></i><b>6.2.1</b> Krona plot</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="06-Taxonomic_profiling.html"><a href="06-Taxonomic_profiling.html#running-bracken"><i class="fa fa-check"></i><b>6.3</b> Running Bracken</a></li>
<li class="chapter" data-level="6.4" data-path="06-Taxonomic_profiling.html"><a href="06-Taxonomic_profiling.html#lefse-biomarker-detection"><i class="fa fa-check"></i><b>6.4</b> LEfSe biomarker detection</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="07-Functional_profiling.html"><a href="07-Functional_profiling.html"><i class="fa fa-check"></i><b>7</b> Functional profiling</a>
<ul>
<li class="chapter" data-level="7.1" data-path="07-Functional_profiling.html"><a href="07-Functional_profiling.html#a-demo-run-of-humann2"><i class="fa fa-check"></i><b>7.1</b> A demo run of HUMANn2</a></li>
<li class="chapter" data-level="7.2" data-path="07-Functional_profiling.html"><a href="07-Functional_profiling.html#statistical-comparison-between-samples"><i class="fa fa-check"></i><b>7.2</b> Statistical comparison between samples</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="07-Functional_profiling.html"><a href="07-Functional_profiling.html#combining-data"><i class="fa fa-check"></i><b>7.2.1</b> Combining data</a></li>
<li class="chapter" data-level="7.2.2" data-path="07-Functional_profiling.html"><a href="07-Functional_profiling.html#renormalising-data"><i class="fa fa-check"></i><b>7.2.2</b> Renormalising data</a></li>
<li class="chapter" data-level="7.2.3" data-path="07-Functional_profiling.html"><a href="07-Functional_profiling.html#visualisation"><i class="fa fa-check"></i><b>7.2.3</b> Visualisation</a></li>
<li class="chapter" data-level="7.2.4" data-path="07-Functional_profiling.html"><a href="07-Functional_profiling.html#finding-statistically-significant-differences"><i class="fa fa-check"></i><b>7.2.4</b> Finding statistically significant differences</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="08-Metagenome_assembly.html"><a href="08-Metagenome_assembly.html"><i class="fa fa-check"></i><b>8</b> Metagenome assembly</a>
<ul>
<li class="chapter" data-level="8.1" data-path="08-Metagenome_assembly.html"><a href="08-Metagenome_assembly.html#a-primer-on-short-read-assembly"><i class="fa fa-check"></i><b>8.1</b> A primer on short read assembly</a></li>
<li class="chapter" data-level="8.2" data-path="08-Metagenome_assembly.html"><a href="08-Metagenome_assembly.html#stitching-read-pairs"><i class="fa fa-check"></i><b>8.2</b> Stitching read pairs</a></li>
<li class="chapter" data-level="8.3" data-path="08-Metagenome_assembly.html"><a href="08-Metagenome_assembly.html#assembly"><i class="fa fa-check"></i><b>8.3</b> Assembly</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Shotgun Metagenomics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="taxonomic-profiling" class="section level1" number="6">
<h1><span class="header-section-number">Chapter 6</span> Taxonomic profiling</h1>
<p><img src="figures/quality_trimming_and_filtering.png" width="30%" style="display: block; margin: auto;" /></p>
<p>There are a number of methods for determining the species composition of a metagenomic data-set, but for the purposes of this practical we will use Kraken &amp; Bracken (Bayesian Reestimation of Abundance with KrakEN). Kraken classifies short DNA with taxonomic labels and is frequently used for metagenomic studies. We will be using Kraken 1 as Kraken 2 is still in beta. Bracken uses the taxonomic labels assigned by Kraken to compute the abundance of species in a set of DNA sequences.</p>
<p>First, we’ll make a new directory for it and move into it, after returning home:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="06-Taxonomic_profiling.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..</span>
<span id="cb15-2"><a href="06-Taxonomic_profiling.html#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> 3-Taxonomy</span>
<span id="cb15-3"><a href="06-Taxonomic_profiling.html#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> 3-Taxonomy</span></code></pre></div>
<div id="running-kraken" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Running Kraken</h2>
<p>Prior to running kraken we can set a variable so kraken knows where to look for the databases it will use.</p>
<p>export KRAKEN_DB_PATH=/pub39/tea/matthew/teaching/Kraken_db/MiniKraken/</p>
<p><strong>Note</strong>: You can look at the contents of the above directory to see it currently contains the MiniKraken 4GB database. This database contains 2.7% of the kmers from the full Kraken database. This is used in this practical due to restrictions on time and computational resources. For your own analyses we would recommend the full Kraken database which uses all the bacteria, achaeal and viral complete genomes that are in Refseq at the time of building. As of October 2017, this includes ~25,000 genomes, requiring 33GB of disk space.</p>
<p>Now, run Kraken on sample K1 by running the following command.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="06-Taxonomic_profiling.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kraken</span> --paired --db minikraken_4GB --threads 4 --output K1.kraken.out <span class="kw">\</span></span>
<span id="cb16-2"><a href="06-Taxonomic_profiling.html#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">../2-Trimmed/K1_R1.fq.gz</span> ../2-Trimmed/K1_R2.fq.gz</span></code></pre></div>
<p>While this is running, let’s look at what those command line options do:</p>
<ul>
<li><code>../2-Trimmed/K1_R1.fq.gz ../2-Trimmed/K1_R2.fq.gz</code> : the trimmed read pairs for K1, which we use as input.</li>
<li><code>--paired</code> : Indicate that we are providing paired reads to Kraken. Internally, Kraken will concatenate the R1 and R2 reads into one sequence with an N between them.</li>
<li><code>--db</code> : Specify the kraken database to be used for taxonomic classification. Previous to the command we set the KRAKEN_DB_PATH so in this case the command will look for the directory called ‘minikraken_4GB’ within the KRAKEN_DB_PATH. Alternatively the full path of the required database could be provided.</li>
<li><code>--threads</code> : How many CPUs the process will use.</li>
<li><code>--output</code> : This is the output file.</li>
</ul>
<p>The output file of kraken contains the following columns:</p>
<ul>
<li><strong>“C”/“U”</strong>: one letter code indicating that the sequence was either classified or unclassified.</li>
<li><strong>The sequence ID</strong>: Obtained from the FASTA/FASTQ header.</li>
<li><strong>Taxonomy ID</strong>: The ID Kraken used to label the sequence; this is 0 if the sequence is unclassified.</li>
<li><strong>Length</strong>: Nucleotide length of the sequence.</li>
<li>A space-delimited list indicating the LCA (lowest common ancestor) mapping of each k-mer in the sequence. For example, “562:13 561:4 A:31 0:1 562:3” would indicate that:
<ul>
<li>the first 13 k-mers mapped to taxonomy ID #562</li>
<li>the next 4 k-mers mapped to taxonomy ID #561</li>
<li>the next 31 k-mers contained an ambiguous nucleotide</li>
<li>the next k-mer was not in the database</li>
<li>the last 3 k-mers mapped to taxonomy ID #562</li>
</ul></li>
</ul>
<p>The output to screen will show how many sequences are classified. This will be lower than normal as we are using the mini Kraken database.</p>
<p>In a real analysis you may use the command “kraken-filter” to ensure your Kraken classifications are high quality. Too many classifications are removed if you attempt it with this dataset, due to the minikraken database used, so we will skip this step.</p>
<p>Once the Kraken commands have finished running, run it on the other two samples. HINT: You will need to change all instances of K1 to K2 or W1 in the above command</p>
</div>
<div id="visualising-kraken-output" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Visualising Kraken output</h2>
<div id="krona-plot" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Krona plot</h3>
<p>Krona is an interactive metagenome species abundance visualisation tool. We need to get our data in the correct format before we view it, however, so we first use a Kraken-supplied script to convert the files:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="06-Taxonomic_profiling.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kraken-translate</span> --db minikraken_4GB <span class="kw">\</span></span>
<span id="cb17-2"><a href="06-Taxonomic_profiling.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">K1.kraken.out</span> <span class="op">&gt;</span> K1.kraken.label</span></code></pre></div>
<p>Next we convert these to a file format that krona will be able to read.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="06-Taxonomic_profiling.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> K1.kraken.label <span class="kw">|</span> <span class="fu">cut</span> -f 2 <span class="kw">|</span> <span class="fu">sort</span> <span class="kw">|</span> <span class="fu">uniq</span> -c <span class="kw">|</span> <span class="fu">tr</span> ‘<span class="kw">;</span>’ ‘\<span class="ex">t</span>’ <span class="op">&gt;</span> K1.krona.txt</span></code></pre></div>
<p>The above command uses the following steps:
- <code>cat K1.kraken.label</code>: cat the file to print out its contents.
- The pipe symbols <code>|</code> are used to pipe the output of one command to the next.
- <code>cut -f 2</code>: The cut command is used to cut out the 2nd column (field).
- <code>sort</code>: The output of the 2nd column is sorted, this is required for the next step.
- <code>uniq -c</code>: Unique count, find every unique string/entry and count how many of each there are.
- <code>tr ‘;’ ‘\t’</code>: Converts ‘;’ for ‘ (tab) characters
- <code>&gt; K1.krona.txt</code>: Redirect the output to the file called <code>K1.krona.txt</code></p>
<p>If you would like to see exactly what the file is doing you can run the command bit by bit i.e</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="06-Taxonomic_profiling.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> K1.kraken.label</span>
<span id="cb19-2"><a href="06-Taxonomic_profiling.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> K1.kraken.label <span class="kw">|</span> <span class="fu">cut</span> -f 2</span>
<span id="cb19-3"><a href="06-Taxonomic_profiling.html#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> K1.kraken.label <span class="kw">|</span> <span class="fu">cut</span> -f 2 <span class="kw">|</span> <span class="fu">sort</span></span>
<span id="cb19-4"><a href="06-Taxonomic_profiling.html#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#etc.</span></span></code></pre></div>
<p>Repeat the above commands for K2 and W1</p>
<p>Once we have all three files converted, we can combine them with a Krona packaged script to generate our charts.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="06-Taxonomic_profiling.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ImportText.pl</span> -o all.krona.html ??.krona.txt</span></code></pre></div>
<p><code>-o</code> is our output html file, and the final argument <code>??.krona.txt</code> represents all of our .krona files in this directory: The <code>?</code> is a wild-card, meaning any character, so this identifies the files <code>K1.krona.txt</code> <code>K2.krona.txt</code> and <code>W1.krona.txt</code>.</p>
<p>Now we can view our chart in a web browser.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="06-Taxonomic_profiling.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">firefox</span> all.krona.html <span class="kw">&amp;</span></span></code></pre></div>
<p>Which sample is the most different in terms of species that are present and absent?</p>
</div>
</div>
<div id="running-bracken" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Running Bracken</h2>
<p>Bracken (Bayesian Reestimation of Abundance with KrakEN) uses taxonomy labels assigned by Kraken to compute the abundance of species in a metagenomic sample.</p>
<p>Prior to Bracken we need to create a Kraken report file</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="06-Taxonomic_profiling.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kraken-report</span> --db minikraken_4GB K1.kraken.out <span class="op">&gt;</span> K1.kreport</span></code></pre></div>
<p>Now it’s time for the bracken command</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="06-Taxonomic_profiling.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bracken</span> -d <span class="va">$KRAKEN_DB_PATH</span>/minikraken_4GB <span class="kw">\</span></span>
<span id="cb23-2"><a href="06-Taxonomic_profiling.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-i</span> K1.kreport -o K1.bracken -r 100 -l S -t 5</span></code></pre></div>
<p>Let’s look at what those command line options do:</p>
<ul>
<li><code>-d</code> : Specify the Kraken database that was used for taxonomic classification. In this case bracken requires the variable <code>$KRAKEN_DB_PATH</code> so the option is provided the full path to the kraken database. For clarity try the command <code>ls ${KRAKEN_DB_PATH}/minikraken_4GG</code></li>
<li><code>-i</code> : The Kraken report file, this will be used as the input.</li>
<li><code>-o</code> : The output bracken file. Information about its contents is below.</li>
<li><code>-r 100</code>: This is the ideal length of the reads that were used in the kraken classification. It is recommended that the initial read length of the sequencing data is used. We are using 100 here as it is a paired library of 100 bp reads.</li>
<li><code>-l S</code>: This specifies the taxonomic level/rank of the Bracken output. In this case S is equal to species with the other options being ‘D,’‘P,’‘C,’‘O,’‘F’ and ‘G.’</li>
<li><code>-t 5</code>: This specifies the minimum number of reads required for a classification at the specified rank. Any classifications with fewer reads than the specified threshold will not receive additional reads from higher taxonomy levels when distributing reads for abundance estimation. Five has been chosen here for this example data but in real datasets you may want to increase this number (default is 10).</li>
</ul>
<p>The output file of Bracken contains the following columns:</p>
<ol style="list-style-type: decimal">
<li>Name: Name of taxonomy at the specified tax level.</li>
<li>Taxonomy ID: NCBI taxonomy id</li>
<li>Level ID: Letter signifying the taxonomic level of the classification</li>
<li>Kraken assigned read: Number of reads assigned assigned the taxonomy by Kraken.</li>
<li>Added reads with abundance reestimation: Number of reads added to the taxonomy by Bracken abundance reestimation.</li>
<li>Total reads after abundance reestimation: Number from field 4 and 5 summed. This is the field that will be used for downstream analysis.</li>
<li>Fraction of total reads: Relative abundance of the taxonomy.</li>
</ol>
<p>Use <code>less</code> or <code>vim</code> to look at the bracken output.</p>
<p>Repeat the above commands for K2 and W1</p>
<p>To make full use of Bracken output, it is best to merge the output into one table. However before we do this we’ll copy the Bracken output of other samples that have been generated prior to the workshop. These are all either Korean or Western Diet samples.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="06-Taxonomic_profiling.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> <span class="va">$DB</span>/bracken/* .</span></code></pre></div>
<p>Now to merge all the Bracken files.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="06-Taxonomic_profiling.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">combine_bracken_outputs.py</span> --files *.bracken -o all.bracken</span></code></pre></div>
<p>This output file contains the first three columns:
- <strong>name</strong> = Organism group name. This will be based on the TAX_LVL chosen in the bracken command and will only show the one level
- <strong>taxonomy_id</strong> = Taxonomy id number
- <strong>taxonomy_lvl</strong> = A single string indicating the taxonomy level of the group. (‘D,’‘P,’‘C,’‘O,’‘F,’‘G,’‘S’).</p>
<p>Following these columns are two columns for each sample.</p>
<ul>
<li><code>${SampleName}.bracken_num</code>: The number of reads after abundance</li>
<li><code>${SampleName}.bracken_frac</code>: Relative abundance of group in sample</li>
</ul>
<p>We want a file with only the first column and the bracken_num column for each sample. We can therefore use the following commands.</p>
<p>Create a sequence of numbers that will match the bracken_num column numbers. Use “seq –help” to see how the seq command works.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="06-Taxonomic_profiling.html#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="va">bracken_num_columns=$(</span><span class="fu">seq</span> -s , 4 2 50<span class="va">)</span></span>
<span id="cb26-2"><a href="06-Taxonomic_profiling.html#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="va">$bracken_num_columns</span></span></code></pre></div>
<p>Now to use the variable to extract the bracken_num columns plus the first column (species names).</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="06-Taxonomic_profiling.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> all.bracken <span class="kw">|</span> <span class="fu">cut</span> -f 1,<span class="va">$bracken_num_columns</span> <span class="op">&gt;</span> all_num.bracken</span></code></pre></div>
</div>
<div id="lefse-biomarker-detection" class="section level2" number="6.4">
<h2><span class="header-section-number">6.4</span> LEfSe biomarker detection</h2>
<p>We will use LEfSe (Linear discriminant analysis Effect Size) to determine which taxa can most likely explain the differences between the Western and Korean diet. LEfSe couples standard tests for statistical significance with additional tests encoding biological consistency and effect relevance. It can be used with other features such as organisms, clades, operational taxonomic units, genes, or functions.</p>
<p>In essence it allows for the detection of biomarkers when comparing sample groups. In the LEfSe terminology the sample groups are called the class.</p>
<p>We need to format our bracken file to be ready for LEfSe. First we will copy the file so we have a backup in case we do anything wrong.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="06-Taxonomic_profiling.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> all_num.bracken all_num.lefse.bracken</span></code></pre></div>
<p>This next part must be done for further commands to work</p>
<p>Using your favourite text editor add the following line to the top of your all_num.lefse.bracken file. The words are separated by tabs. If you are not sure how to carry out this task please ask a demonstrator.</p>
<p>diet K K K K K K K K K K K K W W W W W W W W W W W W</p>
<p>i.e. the above is diet followed by 12 Ks and 12 Ws</p>
<p>The singular line should match the order of your samples within the file. This is the metadata line that LEfSe will use to determine which samples belong to each sample group, and therefore which to compare. In this case it is Korean diet samples versus Western diet samples.</p>
<p>The easiest way to install LEfSe is through conda (for info to install conda and LEfSe through conda please see the following instructions <a href="https://conda.io/en/latest/" class="uri">https://conda.io/en/latest/</a>, <a href="https://anaconda.org/bioconda/lefse" class="uri">https://anaconda.org/bioconda/lefse</a>). We will activate a preconstructed LEfSe conda environment with the following script.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="06-Taxonomic_profiling.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">lefse_env.sh</span></span></code></pre></div>
<p>Although we have formatted the input file already we need to further format and preprocess it with a LEfSe script.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="06-Taxonomic_profiling.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">lefse-format_input.py</span> all_num.lefse.bracken all_num.lefse -c 1 -u 2 -o 1000000</span></code></pre></div>
<ul>
<li><code>all_num.lefse.bracken</code> : Input Bracken file.</li>
<li><code>all_num.lefse</code> : Output file formatted for the run_lefse command, which we will soon run</li>
<li><code>-c 1</code> : Specifies the row with the class info. This is used to determine which sample will be compared against which samples. In this case it is the 1st row with the Ks and Ws.</li>
<li><code>-u 2</code> : Specifies the row with the sample names. This is the second row in this case.</li>
<li><code>-o 1000000</code> : An integer can be indicated to determine to what size (count sum value) each sample should be normalised to. LEfSe developers recommend 1000000 (1 million) when very low values a present. We generally always use 1 million for consistency.</li>
</ul>
<p>Now to run LEfSe. All we need to do is run the command with the formatted input and provide an output file name.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="06-Taxonomic_profiling.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">run_lefse.py</span> all_num.lefse all_num.lefse.out</span></code></pre></div>
<p>The output file is a tab-delimited file which contains a row for each species. Biomarkers will have the five columns below whilst non-biomarkers will have the first two followed by a “-.”</p>
<ul>
<li>Biomarker name</li>
<li>Log of highest class average, i.e. Get the class with the greater amounts of the biomarker, average the counts and then get the log of this value.</li>
<li>Class with the greater amounts of biomarker</li>
<li>LDA effect size: A statistical figure for LEfSe. Only features with an LDA &gt;2 are detected as biomarkers by default. The higher the LDA effect size is the more of an effect the biomarker causes.</li>
<li>p-value: biomarkers must have a p-value of &lt;0.05 to be considered significant.
T
he LDA effect size indicates how much of an effect each biomarker has. The default is to only count a species with an LDA effect size of greater than 2 or less than -2 as a biomarker. The further the LDA effect size is from 0 the greater the effect the species causes.</li>
</ul>
<p>Next we can visualise the output.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="06-Taxonomic_profiling.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">lefse-plot_res.py</span> --dpi 200 --format png all_num.lefse.out biomarkers.png</span></code></pre></div>
<ul>
<li><code>--dpi 200</code> : Dots per inch. This refers to the resolution of the output image. Normally publications want 300 dpi. We’ve chosen 200 as it is good quality and we will not be publishing these results.</li>
<li><code>--format png</code> : Format of output file. png is a commonly used file format for images.</li>
<li><code>all_num.lefse.out</code> : LEfSe output to visualise.</li>
<li><code>biomarkers.png</code> : Plot showing the LDA scores of the species detected as biomarkers. Colouring shows which class (K or W) the species is found in higher abundance.</li>
</ul>
<p>Look at the figure with the program okular:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="06-Taxonomic_profiling.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">okular</span> biomarkers.png</span></code></pre></div>
<p>Which species causes the biggest effect in the W class and in the K class? Which class has more biomarkers associated with it?</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="05-Trimming_data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="07-Functional_profiling.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
